---
title: "Lab 2 - Checkpoint 4"
author: "Marcos Nascimento (marcosantonio@copin.ufcg.edu.br)"
date: "Abril 25, 2018"
output:
  html_document:
    df_print: paged
---

<style>
    body {text-align: justify;
    font-family: "Times New Roman";
    -webkit-column-count:2;}
</style>

O objeto principal da análise são as buscas e a navegação depois da busca. Criamos esses dados a partir dos dados originais da wikimedia em `/data/search_data.csv`. 

Aqui, exploramos esses dados. 

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(fig.align="center", fig.width=7, fig.height=4)
knitr::opts_chunk$set(warning = FALSE)

library(tidyverse)
library(here)
library(lubridate)
library(shiny)
library(plotly)
theme_set(theme_bw())
```

# Como são as buscas no Wikimidia?

## Coleção de dados

```{r ETL}
#todas as sessões de buscas
buscas = read_csv(here::here("data/search_data.csv")) %>%
    mutate(day=round_date(session_start_date, unit = "day"))
```

## Contexto da pesquisa e questões de pesquisa

## Distribuição dos dados
### Visualizando as distribuições
```{r}
#What is our daily overall clickthrough rate? How does it vary between the groups?
#group
#num_clicks
#session_start_date
```

```{r}
#group
buscas %>% 
    group_by(group) %>% 
    summarise(n = n()) %>% 
    ggplot(aes(x = group, y = n, color=group)) + 
    geom_col(fill="white") +
    ggtitle("Distribuição da frequência do grupo da sessão") +
    xlab("Grupo") + 
    ylab("Frequência") +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none")

buscas %>%
  subset(select = c(group)) %>%
  summary()
```

```{r}
#num_clicks
buscas %>% 
    ggplot(aes(x = group, y = num_clicks)) + 
    geom_jitter(aes(alpha = .4, width = .2, size = .8, color = group)) +
    ggtitle("Distribuição da quantidade de cliques") +
    xlab("Grupo") + 
    ylab("Quantidade de cliques") +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none")

buscas %>% 
    ggplot(aes(x = group, y = num_clicks)) + 
    geom_jitter(aes(alpha = .4, width = .2, size = .8, color = group)) +
    scale_y_log10() +
    ggtitle("Distribuição da quantidade de cliques") +
    xlab("Grupo") + 
    ylab("Quantidade de cliques") +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none")

buscas %>% 
    ggplot(aes(x= num_clicks)) + 
    geom_histogram(binwidth = 1, fill = "white", color = "blue") + 
    facet_grid(group ~ .) +
    ggtitle("Distribuição da frequência da quantidade de cliques") +
    xlab("Quantidade de cliques") + 
    ylab("Frequência") +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none")

buscas %>%
  subset(select = c(num_clicks)) %>%
  summary()
```

```{r}
buscas %>% 
    count(day, group) %>% 
    ggplot(aes(x = day, y = n, fill = group)) +
    geom_area() +
    facet_grid(~ group)

buscas %>% 
    count(day, group, num_clicks) %>%
    ggplot(aes(x = num_clicks, y=n, fill=group)) +
    geom_area() +
    facet_wrap(~ day)

buscas %>%
  subset(select = c(session_start_date)) %>%
  summary()
```

```{r}
#search_index quantidade de buscas na sessão

#Which results do people tend to try first? How does it change day-to-day?
#first_click
buscas %>%
    ggplot(aes(x= first_click)) + 
    geom_histogram(binwidth = 20, fill = "white", color = "blue") + 
    facet_grid(group ~ .)

#results
buscas %>%
    ggplot(aes(x= results)) + 
    geom_histogram(binwidth = 20, fill = "white", color = "blue") + 
    facet_grid(group ~ .)

buscas %>%
  subset(select = c(first_click, results)) %>%
  summary()

#paralelo results and first_click
buscas %>% 
    ggplot(aes(x = first_click, y=results, color=group)) +
    geom_jitter(width = .2, alpha=.4) +
    scale_y_log10() +
    facet_wrap(~ day)
```

```{r}
#What is our daily overall zero results rate? How does it vary between the groups?
buscas %>%
  filter(results == 0) %>%
  count()

buscas %>%
  filter(results == 0) %>%
  
```

## Resultados e discussão
```{r}
#What is our daily overall clickthrough rate? How does it vary between the groups?
counting_by_date = buscas %>% 
    distinct(session_id, .keep_all=TRUE) %>%
    count(day, group) 

counting_by_clicked = buscas %>%
    distinct(session_id, .keep_all=TRUE) %>%
    filter(num_clicks >= 1) %>%
    count(day, group) %>%
    merge(counting_by_date, by=c('day','group'))

colnames(counting_by_clicked) = c("day", "group", "clicked", "total_sessions")

counting_by_clicked = counting_by_clicked %>%
    mutate(clicks_rate=clicked/total_sessions)

counting_by_clicked %>% 
    ggplot(aes(x = day, y = clicks_rate, color = group)) +
    geom_line() +
    geom_point() +
    geom_hline(yintercept=mean(counting_by_clicked$clicks_rate)) +
    facet_grid(~ group)

counting_by_clicked %>% 
    ggplot(aes(x= group, 
               y = clicks_rate,
               color= group)) +
    geom_boxplot(varwidth=T) +
    theme(plot.title = element_text(hjust = 0.5), legend.position="none")

tapply(counting_by_clicked$clicks_rate,
       counting_by_clicked$group,
       median)
```

```{r}
#Which results do people tend to try first? How does it change day-to-day?
first_click_clustered = buscas %>%
    filter(first_click != 'NA') %>%
    group_by(day, group) %>%
    summarise(median=median(first_click))

first_click_clustered %>% 
    ggplot(aes(x= group, 
               y = median,
               color= group)) +
    geom_boxplot(varwidth=T) +
    theme(plot.title = element_text(hjust = 0.5), legend.position="none")
```


```{r}
#What is our daily overall zero results rate? How does it vary between the groups?
```

